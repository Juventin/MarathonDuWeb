<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AdOps Helper - Map</title>
    <link rel="icon" type="image/png" href="img/favicon.png" />

    <link rel="stylesheet" href="style.css">

    <link rel="stylesheet" href="range-slider-master/css/rSlider.min.css">
    <script src="range-slider-master/js/rSlider.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/data.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>
    <link rel="stylesheet" href="bubble.css">
    <link rel="stylesheet" href="styletop5.css">
  </head>
  <body>

    <!-- SIDENAV  -->
    <div id="sidenav">

        <!-- HEADER  -->
        <div id="logo" onmouseover="displaybubble()" style="cursor: pointer; border-bottom: 2px solid #60B183; border-right: 2px solid #60B183">
            <a href="index.html">
                <img src="img/logo-white.png" style="width: 100%">
            </a>
        </div>
        <div id="instructions">
            <p>Select your criterias</p>
        </div>

        <!-- CRITERES  -->
        <div id="criteriacontent">

            <!-- GENRE  -->
            <div class="criteria" id="gender">
                <h2>Gender <img src="img/down-arrow.png" class="arrow down" id="arrowgender" onclick="toggle('gender')"></h2>
                <div class="boutons hidden" id="buttonsgender">
                    <div>
                        <img src="img/gender-female.png" id="female" class="imgbutton" onclick="select('female')">
                        <img src="img/gender-male.png" id="male" class="imgbutton" onclick="select('male')">
                    </div>
                    <div>
                        <p class="legende"onclick="select('female')">Female</p><p class="legende" onclick="select('male')">Male</p>
                    </div>
                </div>
            </div>

            <!-- AGE  -->
            <div class="criteria" id="age">
                <h2>Age range <img src="img/down-arrow.png" class="arrow down" id="arrowage" onclick="toggle('age')"></h2>
                <div class="boutons hidden" id="buttonsage">

                    <div>
                        <img src="img/age-baby.png" id="baby" class="imgbutton" onclick="select('baby')">
                        <img src="img/age-daddy.png" id="daddy" class="imgbutton" onclick="select('daddy')">
                        <img src="img/age-papy.png" id="papy" class="imgbutton" onclick="select('papy')">
                    </div>
                    <div>
                        <p class="legende" onclick="select('baby')">18-25</p><p class="legende" onclick="select('daddy')">26-50</p><p class="legende" onclick="select('papy')">50+</p>
                    </div>

                </div>
            </div>

            <!-- SALAIRE  -->
            <div class="criteria" id="salary">
                <h2>Salary range <img src="img/down-arrow.png" class="arrow down" id="arrowsalary" onclick="toggle('salary')"></h2>
                <div class="boutons hidden" id="buttonssalary">

                    <div class="sliderwidget">
                        <img src="img/salary-min.png" class="imgbutton">
                        <input type="text" id="slidersalary" class="slider">
                        <img src="img/salary-max.png" class="imgbutton">
                    </div>
                    <div class="slidertext">
                        <input type="text" id="minsalary" class="slidertextinput" value="2" onKeyUp="sliderSalary.setValues(parseInt(document.getElementById('minsalary').value), parseInt(document.getElementById('maxsalary').value))">
                        <input type="text" id="maxsalary" class="slidertextinput" value="3" onKeyUp="sliderSalary.setValues(parseInt(document.getElementById('minsalary').value), parseInt(document.getElementById('maxsalary').value))">
                    </div>

                    <img src="img/more.png" id="addsalary" class="addinterval" onclick="addcritere('salary')">

                    <div class="sliderwidget hidden" id="widgetsalary2">
                        <img src="img/salary-min.png" class="imgbutton">
                        <input type="text" id="slidersalary2" class="slider">
                        <img src="img/salary-max.png" class="imgbutton">
                    </div>
                    <div class="slidertext hidden" id="textsalary2">
                        <input type="text" id="minsalary2" class="slidertextinput" value="2" onKeyUp="sliderSalary2.setValues(parseInt(document.getElementById('minsalary2').value), parseInt(document.getElementById('maxsalary2').value))">
                        <input type="text" id="maxsalary2" class="slidertextinput" value="3" onKeyUp="sliderSalary2.setValues(parseInt(document.getElementById('minsalary2').value), parseInt(document.getElementById('maxsalary2').value))">
                    </div>
                    
                </div>
            </div>

            <!-- INTERETS  -->
            <div class="criteria" id="interests">
                <h2>Interests <img src="img/down-arrow.png" class="arrow down" id="arrowinterests" onclick="toggle('interests')"></h2>
                <div class="boutons hidden" id="buttonsinterests">
                    <input type="text" id="searchinterests" class="interestsinput" placeholder="Search..." onkeyup="search()">
                    <ul class="formulaire" id="formulaire">
                        <li>
                            <input type="checkbox" onchange="show_map(this)" id="arts" name="arts">
                            <label for="arts">Arts et divertissements</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="automobile" name="automobile">
                            <label for="automobile">Automobile</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="affaires" name="affaires">
                            <label for="affaires">Affaires</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="carrieres" name="carrieres">
                            <label for="carrieres">Carrières</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="education" name="education">
                            <label for="education">Éducation</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="famille" name="famille">
                            <label for="famille">Famille et parentalité</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="santé" name="santé">
                            <label for="santé">Santé et mise en forme</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="alimentation" name="alimentation">
                            <label for="alimentation">Alimentation et boissons</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="loisirs" name="loisirs">
                            <label for="loisirs">Loisirs et intérêts</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="maison" name="maison">
                            <label for="maison">Maison et jardin</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="droit" name="droit">
                            <label for="droit">Droit et politique</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="actualites" name="actualites">
                            <label for="actualites">Actualités</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="finances" name="finances">
                            <label for="finances">Finances personnelles</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="societe" name="societe">
                            <label for="societe">Société</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="sciences" name="sciences">
                            <label for="sciences">Sciences</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="animaux" name="animaux">
                            <label for="animaux">Animaux</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="sports" name="sports">
                            <label for="sports">Sports</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="style" name="style">
                            <label for="style">Style et mode</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="technologie" name="technologie">
                            <label for="technologie">Tech et informatique</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="voyage" name="voyage">
                            <label for="voyage">Voyage</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="immobilier" name="immobilier">
                            <label for="immobilier">Immobilier</label>
                        </li><li>
                            <input type="checkbox" onchange="show_map(this)" id="shopping" name="shopping">
                            <label for="shopping">Shopping</label>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <!-- MAP  -->
    <div id="mapdiv">
        <p id="chargement">Loading ...</p>
    </div>
    <div id="top5">
        <p class='top5titre'>TOP 5 :</p>
        <ol id="listeol"></ol>
    </div>


    <div id="bubble" class="bubble hiddenbubble" style="width: 210px; margin-top: 20px;">
        <ul>
            <li>
                <a href="map.html" style="display:block" >
                <img src="imggrandes/logo-map.png"> Map
                </a>
            </li>
            <li>
                <a href="twitter.html" style="display:block" >
                <img src="imggrandes/logo-twitter.png"> Twitter
                </a>
            </li>
            <li>
                <a href="goal.html" style="display:block" >
                <img src="imggrandes/logo-goal.png"> Goal
                </a>
            </li>
            <li>
                <a href="trend.html" style="display:block" >
                <img src="imggrandes/logo-trend.png"> Trend
                </a>
            </li>
        </ul>
    </div>

    <script>


        
        function displaybubble(){
            document.getElementById('bubble').className = "bubble";
            setTimeout(() => {
                document.getElementById('bubble').className = "bubble hiddenbubble"
                },15000);
        }
        

        // SLIDERS 

        var sliderSalary = new rSlider({
            target: '#slidersalary',
            values: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 10, 31, 32, 33, 34, 35],
            range: true,
            set: [16, 21],
            tooltip: false,
            width: "100px",
            labels: false,
            onChange: function(values){
                values = values.split(',')
                console.log(values)
                document.getElementById('minsalary').value = parseInt(values[0])
                document.getElementById('maxsalary').value = parseInt(values[1])


                var tab = [];
                $.ajax({
                    type: 'GET',
                       contentType: 'Content-type: text/plain; charset=iso-8859-1',
                       dataType: "text",
                       beforeSend: function(jqXHR) {
                           jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                       },
                    url: './data/salary_normalized.csv',
                    dataType: 'text',
                    success: function(data){
                        var lines = data.trim().split('\n');
                        for(i = 1; i < lines.length - 1; i ++){
                            var row = lines[i];
                            var cells = row.split(";");
                            tmp = 0;
                            for (var s = document.getElementById('minsalary').value; s <= document.getElementById('maxsalary').value; s++) {
                                //console.log(parseInt(s)+2);
                                tmp += parseFloat(cells[(parseInt(s)+2)].replace(",","."));
                            }
                            tab.push([cells[0], tmp.toString().replace(".",",")]);
                        }
                        //console.log(tab);
                        datas[5] = tab;


                        var nb_dept = 100;
                        var nb_var = datas.length;
                        var savedpt = -1;
                        for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                            tmp = 0;
                            for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                if(datas[i] != ""){
                                    savedpt = i;
                                    tmp += parseFloat(datas[i][j][1].replace(",","."))
                                }
                            }
                            if(savedpt != -1){
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                        }
                        var chart = $('#mapdiv').highcharts();
                        chart.series[0].update({data: tab2json(score_finaux)}, false);
                        chart.redraw();
                    }
                });

            }
        }); 

        var sliderSalary2 = new rSlider({
            target: '#slidersalary2',
            values: [1, 2, 3, 4, 5, 6, 7, 8],
            range: true,
            set: [2, 3],
            tooltip: false,
            width: "100px",
            labels: false,
            onChange: function(values){
                document.getElementById('minsalary2').value = parseInt(values[0])
                document.getElementById('maxsalary2').value = parseInt(values[2])

                var tab = [];
                $.ajax({
                    type: 'GET',
                       contentType: 'Content-type: text/plain; charset=iso-8859-1',
                       dataType: "text",
                       beforeSend: function(jqXHR) {
                           jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                       },
                    url: './data/salary_normalized.csv',
                    dataType: 'text',
                    success: function(data){
                        var lines = data.trim().split('\n');
                        for(i = 1; i < lines.length - 1; i ++){
                            var row = lines[i];
                            var cells = row.split(";");
                            tmp = 0;
                            for (var s = document.getElementById('minsalary2').value; s <= document.getElementById('maxsalary2').value; s++) {
                                tmp += parseFloat(cells[(parseInt(s)+2)].replace(",","."));
                            }
                            tab.push([cells[0], tmp.toString().replace(".",",")]);
                        }
                        //console.log(tab);
                        datas[6] = tab;


                        var nb_dept = 100;
                        var nb_var = datas.length;
                        var savedpt = -1;
                        for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                            tmp = 0;
                            for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                if(datas[i] != ""){
                                    savedpt = i;
                                    tmp += parseFloat(datas[i][j][1].replace(",","."))
                                }
                            }
                            if(savedpt != -1){
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                        }
                        var chart = $('#mapdiv').highcharts();
                        chart.series[0].update({data: tab2json(score_finaux)}, false);
                        chart.redraw();
                    }
                });
            }
        });

        // Doc : https://www.cssscript.com/animated-customizable-range-slider-pure-javascript-rslider-js/
    
        var datas = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
        var score_finaux= [];
        // SELECT GENDER 
        function select(id) {
            if(document.getElementById(id).className == "imgbutton active"){
                document.getElementById(id).className = "imgbutton"
                if(id == 'male'){
                    datas[0] = [];
                }
                if(id == 'female'){
                    datas[1] = [];
                }
                if(id == 'baby'){
                    datas[2] = [];
                }
                if(id == 'daddy'){
                    datas[3] = [];
                }
                if(id == 'papy'){
                    datas[4] = [];
                }
                var nb_dept = 100;
                var nb_var = datas.length;
                var savedpt = -1;
                for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                    tmp = 0;
                    for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                        if(datas[i] != ""){
                            savedpt = i;
                            tmp += parseFloat(datas[i][j][1].replace(",","."))
                        }
                    }
                    if(savedpt != -1){
                        var moy = tmp/datas.filter(String).length;
                        score_finaux.push([datas[savedpt][j][0], moy]);
                    }
                }
                if(savedpt != -1){
                    var chart = $('#mapdiv').highcharts();
                    chart.series[0].update({data: tab2json(score_finaux)}, false);
                    chart.redraw();
                }else{
                    var chart = $('#mapdiv').highcharts();
                    chart.series[0].update({data: processed_json}, false);
                    chart.redraw();                        
                }
            } else {
                document.getElementById(id).className = "imgbutton active"
                if(id == 'male'){                    
                    var tab = [];
                    $.ajax({
                        type: 'GET',
                           contentType: 'Content-type: text/plain; charset=iso-8859-1',
                           dataType: "text",
                           beforeSend: function(jqXHR) {
                               jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                           },
                        url: './data/sexe_normalized.csv',
                        dataType: 'text',
                        success: function(data){
                            var lines = data.trim().split('\n');
                            for(i = 1; i < lines.length - 1; i ++){
                                var row = lines[i];
                                var cells = row.split(";");
                                tab.push([cells[0], cells[2]]);
                            }
                            datas[0] = tab;


                            var nb_dept = 100;
                            var nb_var = datas.length;
                            var savedpt = -1;
                            for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                                tmp = 0;
                                for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                    if(datas[i] != ""){
                                        savedpt = i;
                                        tmp += parseFloat(datas[i][j][1].replace(",","."))
                                    }
                                }
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: tab2json(score_finaux)}, false);
                            chart.redraw();
                        }
                    });
                }
                if(id == 'female'){                    
                    var tab = [];
                    $.ajax({
                        type: 'GET',
                           contentType: 'Content-type: text/plain; charset=iso-8859-1',
                           dataType: "text",
                           beforeSend: function(jqXHR) {
                               jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                           },
                        url: './data/sexe_normalized.csv',
                        dataType: 'text',
                        success: function(data){
                            var lines = data.trim().split('\n');
                            for(i = 1; i < lines.length - 1; i ++){
                                var row = lines[i];
                                var cells = row.split(";");
                                tab.push([cells[0], cells[3]]);
                            }
                            datas[1] = tab;


                            var nb_dept = 100;
                            var nb_var = datas.length;
                            var savedpt = -1;
                            for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                                tmp = 0;
                                for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                    if(datas[i] != ""){
                                        savedpt = i;
                                        tmp += parseFloat(datas[i][j][1].replace(",","."))
                                    }
                                }
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: tab2json(score_finaux)}, false);
                            //console.log(tab2json(score_finaux));
                            chart.redraw();
                        }
                    });
                }
                if(id == 'baby'){                    
                    var tab = [];
                    $.ajax({
                        type: 'GET',
                           contentType: 'Content-type: text/plain; charset=iso-8859-1',
                           dataType: "text",
                           beforeSend: function(jqXHR) {
                               jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                           },
                        url: './data/age_normalized.csv',
                        dataType: 'text',
                        success: function(data){
                            var lines = data.trim().split('\n');
                            for(i = 1; i < lines.length - 1; i ++){
                                var row = lines[i];
                                var cells = row.split(";");
                                tab.push([cells[0], cells[2]]);
                            }
                            datas[2] = tab;


                            var nb_dept = 100;
                            var nb_var = datas.length;
                            var savedpt = -1;
                            for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                                tmp = 0;
                                for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                    if(datas[i] != ""){
                                        savedpt = i;
                                        tmp += parseFloat(datas[i][j][1].replace(",","."))
                                    }
                                }
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: tab2json(score_finaux)}, false);
                            //console.log(tab2json(score_finaux));
                            chart.redraw();
                        }
                    });
                }
                if(id == 'daddy'){                    
                    var tab = [];
                    $.ajax({
                        type: 'GET',
                           contentType: 'Content-type: text/plain; charset=iso-8859-1',
                           dataType: "text",
                           beforeSend: function(jqXHR) {
                               jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                           },
                        url: './data/age_normalized.csv',
                        dataType: 'text',
                        success: function(data){
                            var lines = data.trim().split('\n');
                            for(i = 1; i < lines.length - 1; i ++){
                                var row = lines[i];
                                var cells = row.split(";");
                                tab.push([cells[0], cells[3]]);
                            }
                            datas[3] = tab;


                            var nb_dept = 100;
                            var nb_var = datas.length;
                            var savedpt = -1;
                            for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                                tmp = 0;
                                for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                    if(datas[i] != ""){
                                        savedpt = i;
                                        tmp += parseFloat(datas[i][j][1].replace(",","."))
                                    }
                                }
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: tab2json(score_finaux)}, false);
                            //console.log(tab2json(score_finaux));
                            chart.redraw();
                        }
                    });
                }
                if(id == 'papy'){                    
                    var tab = [];
                    $.ajax({
                        type: 'GET',
                           contentType: 'Content-type: text/plain; charset=iso-8859-1',
                           dataType: "text",
                           beforeSend: function(jqXHR) {
                               jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                           },
                        url: './data/age_normalized.csv',
                        dataType: 'text',
                        success: function(data){
                            var lines = data.trim().split('\n');
                            for(i = 1; i < lines.length - 1; i ++){
                                var row = lines[i];
                                var cells = row.split(";");
                                tab.push([cells[0], cells[4]]);
                            }
                            datas[4] = tab;


                            var nb_dept = 100;
                            var nb_var = datas.length;
                            var savedpt = -1;
                            for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                                tmp = 0;
                                for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                    if(datas[i] != ""){
                                        savedpt = i;
                                        tmp += parseFloat(datas[i][j][1].replace(",","."))
                                    }
                                }
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: tab2json(score_finaux)}, false);
                            //console.log(tab2json(score_finaux));
                            chart.redraw();
                        }
                    });
                }

            }
        }

        function show_map(cb){
            if(cb.checked){
                if(cb.name == "arts") var indice = 2; //2 23    
                if(cb.name == "automobile") var indice = 3; //2 23    
                if(cb.name == "affaires") var indice = 4; //2 23    
                if(cb.name == "carrieres") var indice = 5; //2 23    
                if(cb.name == "education") var indice = 6; //2 23    
                if(cb.name == "famille") var indice = 7; //2 23    
                if(cb.name == "santé") var indice = 8; //2 23    
                if(cb.name == "alimentation") var indice = 9; //2 23    
                if(cb.name == "loisirs") var indice = 10; //2 23    
                if(cb.name == "maison") var indice = 11; //2 23    
                if(cb.name == "droit") var indice = 12; //2 23    
                if(cb.name == "actualites") var indice = 13; //2 23    
                if(cb.name == "finances") var indice = 14; //2 23    
                if(cb.name == "societe") var indice = 15; //2 23    
                if(cb.name == "sciences") var indice = 16; //2 23    
                if(cb.name == "animaux") var indice = 17; //2 23    
                if(cb.name == "sports") var indice = 18; //2 23    
                if(cb.name == "style") var indice = 19; //2 23    
                if(cb.name == "technologie") var indice = 20; //2 23   
                if(cb.name == "voyage") var indice = 21; //2 23    
                if(cb.name == "immobilier") var indice = 22; //2 23    
                if(cb.name == "shopping") var indice = 23; //2 23             
                var tab = [];
                $.ajax({
                    type: 'GET',
                       contentType: 'Content-type: text/plain; charset=iso-8859-1',
                       dataType: "text",
                       beforeSend: function(jqXHR) {
                           jqXHR.overrideMimeType('text/html;charset=iso-8859-1');
                       },
                    url: './data/google_trends_normalized.csv',
                    dataType: 'text',
                    success: function(data){
                        var lines = data.trim().split('\n');
                        for(i = 1; i < lines.length; i ++){
                            var row = lines[i];
                            var cells = row.split(";");
                            tab.push([cells[0], cells[indice]]);
                        }
                        datas[7+indice-2] = tab;


                        var nb_dept = 100;
                        var nb_var = datas.length;
                        var savedpt = -1;
                        for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                        //console.log(datas[0]);
                            tmp = 0;
                            for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                if(datas[i] != ""){
                                    savedpt = i;
                                    //console.log(parseInt(datas[i][j][1]));
                                    tmp += parseInt(datas[i][j][1].replace(",","."))
                                }
                            }
                            var moy = tmp/datas.filter(String).length;
                            score_finaux.push([datas[savedpt][j][0], moy]);
                        }
                        var chart = $('#mapdiv').highcharts();
                        chart.series[0].update({data: tab2json(score_finaux)}, false);
                        chart.redraw();
                    }
                });
            }else{
                if(cb.name == "arts") var indice = 2; //2 23    
                if(cb.name == "automobile") var indice = 3; //2 23    
                if(cb.name == "affaires") var indice = 4; //2 23    
                if(cb.name == "carrieres") var indice = 5; //2 23    
                if(cb.name == "education") var indice = 6; //2 23    
                if(cb.name == "famille") var indice = 7; //2 23    
                if(cb.name == "santé") var indice = 8; //2 23    
                if(cb.name == "alimentation") var indice = 9; //2 23    
                if(cb.name == "loisirs") var indice = 10; //2 23    
                if(cb.name == "maison") var indice = 11; //2 23    
                if(cb.name == "droit") var indice = 12; //2 23    
                if(cb.name == "actualites") var indice = 13; //2 23    
                if(cb.name == "finances") var indice = 14; //2 23    
                if(cb.name == "societe") var indice = 15; //2 23    
                if(cb.name == "sciences") var indice = 16; //2 23    
                if(cb.name == "animaux") var indice = 17; //2 23    
                if(cb.name == "sports") var indice = 18; //2 23    
                if(cb.name == "style") var indice = 19; //2 23    
                if(cb.name == "technologie") var indice = 20; //2 23   
                if(cb.name == "voyage") var indice = 21; //2 23    
                if(cb.name == "immobilier") var indice = 22; //2 23    
                if(cb.name == "shopping") var indice = 23; //2 23             
                var tab = [];
                datas[7+indice-2] = tab;


                        var nb_dept = 100;
                        var nb_var = datas.length;
                        var savedpt = -1;
                        for(j = 0; j < nb_dept; j ++ ){ //pour chaque département
                            tmp = 0;
                            for(i = 0; i < datas.length; i ++){ //pour chaque valeur du tableau
                                if(datas[i] != ""){
                                    savedpt = i;
                                    tmp += parseInt(datas[i][j][1].replace(",","."))
                                }
                            }
                            if(savedpt != -1){
                                var moy = tmp/datas.filter(String).length;
                                score_finaux.push([datas[savedpt][j][0], moy]);
                            }
                        }

                        if(savedpt != -1){
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: tab2json(score_finaux)}, false);
                            chart.redraw();
                        }else{
                            var chart = $('#mapdiv').highcharts();
                            chart.series[0].update({data: processed_json}, false);
                            chart.redraw();                        
                        }                

                    }
            }
    

        // AJOUT CRITERE 
        function addcritere(id) {
            add = 'add'+id
            document.getElementById(add).className += " hidden";
            widget = 'widget'+id+'2'
            document.getElementById(widget).className = "sliderwidget";
            text = 'text'+id+'2'
            document.getElementById(text).className = "slidertext";
        }


        // HIDE/SHOW CRITERE 
        function toggle(idshort) {
            id = 'buttons'+idshort
            arrow = 'arrow'+idshort
            if(document.getElementById(id).className == 'boutons hidden'){
                document.getElementById(id).className = 'boutons'
                document.getElementById(arrow).className = 'arrow up'
            }
            else {
                document.getElementById(id).className = 'boutons hidden'
                document.getElementById(arrow).className = 'arrow down'
            }
        }


        // RECHERCHE INTERET 
        function search() {
            
            var input, filter, ul, li, a, i, txtValue;

            input = document.getElementById('searchinterests');
            filter = input.value.toUpperCase();
            ul = document.getElementById("formulaire");
            li = ul.getElementsByTagName("li");
            
            for (i = 0; i < li.length; i++) {
                a = li[i].getElementsByTagName("label")[0];
                txtValue = a.textContent || a.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
                } else {
                li[i].style.display = "none";
                }
            }
        }


        // CHART !!
        var top5 = [];
        /*convertir un tableau en objet json*/
        function tab2json(data){
            top5 = [score_finaux.sort(function(a,b){return b[1] - a[1];})[0],score_finaux.sort(function(a,b){return b[1] - a[1];})[1],score_finaux.sort(function(a,b){return b[1] - a[1];})[2],score_finaux.sort(function(a,b){return b[1] - a[1];})[3],score_finaux.sort(function(a,b){return b[1] - a[1];})[4]];
            
            document.getElementById("listeol").innerHTML = ""

            for(var i = 0; i < top5.length; i++){
                document.getElementById("listeol").innerHTML += "<li><strong>"+(i+1)+". "+top5[i][0]+"</strong> : "+top5[i][1].toFixed(2)+"</li></ol>"
            }
            

            str = "[";
                for (var i = 0; i < score_finaux.length; i++) {
                    if(score_finaux[i][1] != 0)
                        str+="{\"nom\":\"" + score_finaux[i][0]+"\", \"value\":"+score_finaux[i][1] + "}";
                    else
                        str+="{\"nom\":\"" + score_finaux[i][0]+"\", \"value\":"+0.001+"}";
                    if(i != score_finaux.length-1) str+=",";
                }
            str += "]";
            score_finaux = [];
            return JSON.parse(str);
        }

        // Ici c'est l'icone download personnalisé de Valou <3
        Highcharts.SVGRenderer.prototype.symbols.download = function (x, y, w, h) {
            var path = [
                // Arrow stem
                'M', x + w * 0.5, y,
                'L', x + w * 0.5, y + h * 0.7,
                // Arrow head
                'M', x + w * 0.3, y + h * 0.5,
                'L', x + w * 0.5, y + h * 0.7,
                'L', x + w * 0.7, y + h * 0.5,
                // Box
                'M', x, y + h * 0.9,
                'L', x, y + h,
                'L', x + w, y + h,
                'L', x + w, y + h * 0.9
            ];
            return path;
        };

          var processed_json = new Array();
        document.addEventListener('DOMContentLoaded', function () {
        //console.log(data);
    
    $.getJSON('json/population.json', function(data) {
        for (i = 0; i < data.length; i++){
            processed_json.push([data[i].nom, data[i].value]);
        }
        //console.log(processed_json);
         
        $.getJSON('json/departements.geojson', function (geojson) {
        
            Highcharts.mapChart('mapdiv', {
                chart: {
                    map: geojson,
                    backgroundColor: 'none',
                    margin: 0
                },
                title: {
                    text: 'Targeting potential',
                     margin: 100,
                     style: {
                        color: '#000000',
                        fontWeight: 'bold',
                        fontSize: '30px',
                        fontFamily: 'Roboto',
                        backgroundColor: 'none'
                    },
                    floating: true
                },
                credits: {
                    enabled : true,
                    text: "Source : Insee, 2020"
                },
                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    },
                    enableDoubleClickZoomTo: true
                },

                exporting: {
                    buttons: {
                        contextButton: {
                            symbol: 'download'
                        }
                    }
                },

                colorAxis: {
                    tickPixelInterval: 60, 
                    minColor: '#eaeaea',
                    maxColor: '#184a5d',/*
                    type: 'logarithmic'*/
                },
                
                 /*legend: {
                    title: {
                        text: 'Nombre d\'individus'
                    },
                    backgroundColor: '#FFFFFF',
                    align: 'right',
                    verticalAlign: 'top',
                    layout: 'vertical',
                    x: 0,
                    y: 100
                },*/

                legend: {
                    title: {
                        text: 'Potential'
                    },
                    floating: true
                },
                
                series: [{
                    animation: true,
                    data: processed_json,
                    keys: ['nom', 'value'],
                    joinBy: 'nom',
                    name: 'Potential',
                    borderColor: '#EFEFEF',
                    nullColor: '#EFEFEF',
                    states: {
                        hover: {
                            color: '#072530'
                        },
                    },
                     tooltip: {
                        pointFormat: '{point.nom}: {point.value}',
                        valueSuffix: ' (score)'
                    },
                    dataLabels: {
                        enabled: false,
                        format: '{point.nom}'
                    }
                }]
            });
        });
    });
        });

    </script>
  </body>
  <script>window.jQuery || document.write('<script src="jquery-3.4.1.min.js"><\/script>')</script>
</html>